version: 2
jobs: 
  build: 
    docker:
      - image: circleci/node:lts
    environment:
      # Variables used in build steps
      # from https://developer.salesforce.com/tools/sfdxcli
      - DX_CLI_URL: https://developer.salesforce.com/media/salesforce-cli/sfdx/channels/stable/sfdx-linux-x64.tar.xz
      - TESTLEVEL: RunLocalTests
      steps:
        - checkout
        - run:
            name: Download CLI
            command: |
              mkdir sfdx
              wget -qO- $DX_CLI_URL | tar xJ -C sfdx --strip-components 1
        - run:
            name: Install CLI
            command: |
              ./sfdx/install
              sfdx
              mkdir tmp
        - run:
            name: Set HEAD in GitHub Repo
            command: |
              #Use a Git pull command to set HEAD correctly in Repo. For build.xml to work properly 
              #below git pull command actually is git pull origin BRANCH NAME from where build is to happen i.e. master/develop/feature etc.
              git config user.email "kbssalesforce77@gmail.com"
              git config user.name "Bheru-sfdc"
              #git pull origin develop
              git pull origin << pipeline.git.branch >>
        - run:
            name: Authorize Target Deployment Org
            command: |
              mkdir keys
              echo $Server_Key | base64 -di > keys/server.key
              echo "Authenticating org"
            s fdx force:auth:jwt:grant --clientid $Consumer_key --jwtkeyfile keys/server.key --username $SFDX_Username --setdefaultdevhubusername -a DevHub
        - run:
            name: convert the files in deploy folder to MDAPI format
            command: |
              #from SFDX project structure CONVERT TO MDAPI format
              sfdx force:source:convert -r deploy -d deploy-sf-metadata     
        - run:
            name: MDAPI Deploy to Target Deployment Org
            no_output_timeout: 300m
            command: |
              #Deploy to target deployment org and run unit tests. 
              sfdx force:mdapi:deploy --checkonly --wait -1 -d deploy-sf-metadata --targetusername $SFDX_Username --testlevel $TESTLEVEL -r $TESTCLASSLIST            

      
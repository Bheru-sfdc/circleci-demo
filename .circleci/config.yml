# Use the latest 2.1 version of CircleCI pipeline process engine. See: https://circleci.com/docs/2.0/configuration-reference
version: 2.1

general:

jobs:
  
  build:
    machine: true
    working_directory: ~/ci_app
    environment:
      # from https://developer.salesforce.com/docs/atlas.en-us.sfdx_setup.meta/sfdx_setup/sfdx_setup_install_cli_standalone.htm
      # and https://developer.salesforce.com/media/salesforce-cli/manifest.json
      - DX_CLI_URL: https://developer.salesforce.com/media/salesforce-cli/sfdx-linux-amd64.tar.xz
      - TESTLEVEL: RunSpecifiedTests
      - TESTCLASSLIST: AccountResourceTest,AccountTriggerHandlerTest,BaseControllerTest,Batch_CertStatusReminderTest,Batch_VoucherRedemptionTest,BatchCertificationSyncTest,BatchCertificationCOVID19Sync_Test,BatchChatTranscriptCaseUpdateTest,BatchContactCertRollupTest,BatchEncryptedCaseIdUpdateTest,BatchExceptionMaintGrantRequestTest,BatchK2DFailureResentVerificationTest,BatchPopulateStatusOnKnowledgeStatsTest,BatchUpdateStatusRequestTypeTest,BatchUpdateSobjectListTest,BatchUpdateTbidOnCaseTest,BatchUpdateTbidOnTestTakerTest,BatchWebassessorRegistrationUploadTest,BatchWebassessorTranscriptUploadTest,BatchWorkerHelperTest,CaseActionsControllerTest,CaseCommentTriggerTest,CaseDeflectionConfigurationSelectorTest,CaseDetailControllerTest,CaseForwardToConnectionsExtTest,CaseNoteTriggerTest,CaseNotificationContentControllerTest,CaseMetadataResourceTest,CasePickerControllerTest,CasePickerServiceHelperTest,CasePickerServiceTest,CaseServiceTest,CaseSelectorTest,CaseTranscriptTriggerTest,CaseTriggerTest,CategoryCaseReasonServiceTest,CaveonControllerTest,CertificationCasePercentageBatchTest,CertificationKryterionSyncTest,CertificationSearchControllerTest,CertificationSharedFileBatchTest,CertificationStatusRequestServiceTest,CertificationStatusSelectorTest,CertificationStatusServiceTest,CertificationStatusTriggerTest,CertificationSyncSchedulerTest,CertificationSyncSettingsTest,CertificationTypeResourceTest,ChangeOwnerControllerTest,CommunityCaseResourceTest,CommunityUserServiceTest,ContactCertificationHandlerTest,ContactHelperTest,ContactLinkerTest,ContactResourceTest,ContactSelectorTest,ContactSupportControllerTest,ContactusControllerTest,ContentDocumentLinksTriggerTest,ContentVersionResourceTest,CredentialProtectionControllerTest,CredentialStatusTemplateControllerTest,CreateWrAndWtForRegionChangeTest,CSATHelperTest,DataCategoryGroupInfoTest,DataCategoryInfoTest,DataCategoryUtilTest,DataCategoryWrapperTest,DeveloperFeedbackControllerTest,DisableRecaptchaTest,EmailMessageHelperTest,EmailMessageTriggerTest,EmpPromotionLowVolumeEmailSchedulerTest,EncryptionUtilTest,EntityMapDuplicateRecordsBatchTest,ExternalSharingListCtrlTest,fflib_SObjectDomainTest,FeaturedArticlesServiceTest,FeatureFlagHelperTest,FreezeCertificationStatusDataBatchTest,GetInvolvedControllerTest,HandleTrailheadUserDataTest,HelpHomeControllerTest,HOCHelperTest,HOCControllerTest,InboundSocialPostHandlerImplTest,IntegrationJobLogsTriggerTest,JWTHelperTest,KBAndSupportControllerTest,KBArticleDisplayControllerTest,KBCategoriesControllerTest,KBSearchControllerTest,KBSearchResultControllerTest,KBVoteControllerTest,KnowledgeArticleStatsTest,KnowledgeTriggerHandlerTest,KryterionCaseResourceTest,LiveChatTranscriptSelectorTest,LowPromotionNotificationSchedulerTest,MyCasesControllerTest,PermissionSetReportSchedulerTest,PersonaHelperTest,PopularArticlesControllerTest,PopularCategoriesControllerTest,PopulateAccountOnAcquiredCompanyTest,PopulateAccountOnCompanyScheduleTest,PopulateTestTakerOnIndividualTest,PopulateTTOnIndividualScheduleTest,PromotionRequestSyncSchedulerTest,PromotionSelectorTest,PromotionTriggerTest,PromotionBatchRequestTriggerTest,QualityAuditMassAssignmentControllerTest,ReCaptchaHandlerWithScoreTest,RangerRequestControllerTest,RecaptchaControllerTest,RegistrationToPromotionLinkHelperTest,RegistrationSelectorTest,RegistrationTriggerTest,RemoveTestTakerFromIndividualTest,RemoveTestTakerScheduleTest,RelatedArticlesControllerTest,RelatedGuidesControllerTest,RESTCaseControllerTest,RuleConditionsTest,ReviewOLPExamsControllerTest,SalesforceCertificationResourceTest,SelfServiceEndPointTest,SharedCaseFileSyncSchedulerTest,SharedCaseStatusBatchTest,StatusRequestSelectorTest,StatusRequestTriggerTest,SubmitCaseControllerTest,SupportLanguageHelperTest,SurveyMonkeyAppResponseTriggerTest,SurveyResponseContentControllerTest,SLAPercentUpdateSchedulerTest,TestTakerToContactLinkUnlinkHelperTest,TestTakerTriggerTest,THBotCaseCommentActionTest,THBotCaseSubmissionRedirectActionTest,THBotCheckOpenCasesExistsActionTest,THBotCSATActionTest,THBotFetchAccountLinkingStatusActionTest,THBotFetchCaseReasonsActionTest,THBotFetchCaseStatusResponseActionTest,THBotFetchCertCategoryDetailsActionTest,THBotFetchCertDetailsActionTest,THBotFetchCertInitInfoActionTest,THBotFetchCertsActionTest,THBotFetchKnowledgeArticleActionTest,THBotFetchOpenCasesActionTest,THBotFetchQuestionDetailsActionTest,THBotInitContactActionTest,THBotOpenCaseActionTest,THBotSearchKnowledgeBaseActionTest,THBotSendCertificationStatusActionTest,TopicSearchResponseTest,TrailheadAndWebassessorLinkingTest,TrailheadCasePercentageBatchTest,TrailheadLinkingLogSelectorTest,TrailheadLinkingLogTriggerTest,TrailheadModuleWrapperTest,TrailheadSupportSettingsTest,TranscriptSelectorTest,TranscriptTriggerTest,UnlinkTrailheadUserControllerTest,UnsubscribeCredentialStatusBatchTest,UpdateRangersRankAcheivedDataTest,UXHOCWrapperTest,VoucherRedemptionControllerTest,WebassessorCalloutBatchExtTest,WebassessorCreateVoucherBatchTest,WebassessorLinkingStatusServiceTest,WebassessorRegistrationSelectorTest,WebassessorRegistrationTriggerTest,WebassessorTranscriptSelectorTest,WebassessorTranscriptTriggerTest,WebassessorVoucherServiceTest,WebCountiresTest,WebToCaseConfigurationsTest,CBRBooleanAlgebraSolverTest,CBREligibilityCatalogRestServiceTest,CBREligibilityCatalogServiceTest,CBRLocalizationServiceTest,CBRRulesServiceTest,SkillHolderBansTest,CBRGraphTest,CBRSkillStatusHelperTest,CBRSkillStatusServiceSkillRegTest,CBRSkillStatusServiceSkillTransTest,SkillHolderEventServiceTest,CBRRegistrationSelectorTest,CBRSkillStatusServiceTest,CBRSkillHoldersTest,CBRProcessMaintSkillHolderEventTest,CBRMaintenanceSyncFlowTest,CBRHigherLevelCertRegistrationWarnTest,CBRHigherLevelCertRegCanceledTest,CBRMaintenanceCompletionEmailSendTest,CredentialHolderMergeServiceTest,GenerateTestHelperTest,BatchCBR_UpdateExternalIdsTest,CBRCreateTestTakerRestServiceTest,CBRCreateTestTakerMaintTest,CertificationTypeHelperTest,CredentialExceptionHandlerTest,RelatedList_CredentialStatusTest
      - selective: yesPlease
      - releaseName: #2022.01.05
      - CIRCLE_COMPARE_URL: << pipeline.project.git_url >>/compare/<< pipeline.git.base_revision >>..<<pipeline.git.revision>>
      - CIRCLECI_PIPELINE_GIT_REVISION: <<pipeline.git.revision>>
      - CIRCLECI_PIPELINE_GIT_BASE_REVISION: << pipeline.git.base_revision >>
      
    steps:
      - checkout # check out the code in the project directory
      - run:
          name: The First Step
          command: |
            echo 'Hello Developer!'
            echo 'This is the delivery pipeline'
      - run:
          name: Download CLI
          command: |
            mkdir sfdx
            wget -qO- $DX_CLI_URL | tar xJ -C sfdx --strip-components 1
      - run:
          name: Install CLI
          command: |
            ./sfdx/install
            sfdx
            mkdir tmp
      - run:
          name: Set HEAD in GitHub Repo
          command: |
            #Use a Git pull command to set HEAD correctly in Repo. For build.xml to work properly 
            #below git pull command actually is git pull origin BRANCH NAME from where build is to happen i.e. master/develop/feature etc.
            git config user.email "kbssalesforce77@gmail.com"
            git config user.name "Bheru-sfdc"
            #git pull origin develop
            git pull origin << pipeline.git.branch >>
 
      - run:
          name: Decrypt server key
          command: |
            #Decrypt server key
            #openssl enc -nosalt -aes-256-cbc -d -in assets/BuildOrg.key.enc -out assets/BuildOrg.key -base64 -K $CONTEXT_DECRYPTION_KEY -iv $CONTEXT_DECRYPTION_IV
            openssl enc -nosalt -aes-256-cbc -d -in $CONTEXT_JWT_KEY_FILE_ENC -out $CONTEXT_JWT_KEY_FILE -base64 -K $CONTEXT_DECRYPTION_KEY -iv $CONTEXT_DECRYPTION_IV       
      - run:
         name: Authorize Target Deployment Org
         command: |
           #Authorize target Deployment org
           #sfdx auth:jwt:grant --clientid XYZ --jwtkeyfile assets/BuildOrg.key --username anurag.bhardwaj@drm.org.anurag --instanceurl https://test.salesforce.com
           sfdx auth:jwt:grant --clientid $CONTEXT_HUB_CONSUMER_KEY --jwtkeyfile $CONTEXT_JWT_KEY_FILE --username $CONTEXT_HUB_SFDX_USER --instanceurl $CONTEXT_INSTANCE_URL --setdefaultdevhubusername -a hub
      - run:
          name: convert the files in deploy folder to MDAPI format
          command: |
            #from SFDX project structure CONVERT TO MDAPI format
            sfdx force:source:convert -r deploy -d deploy-sf-metadata     
      - run:
          name: MDAPI Deploy to Target Deployment Org
          no_output_timeout: 300m
          command: |
            #Deploy to target deployment org and run unit tests. 
            sfdx force:mdapi:deploy --checkonly --wait -1 -d deploy-sf-metadata --targetusername $SFDX_Username --testlevel $TESTLEVEL -r $TESTCLASSLIST            
workflows:
  version: 2
  deploy-feature:
    jobs:
      - build:
          